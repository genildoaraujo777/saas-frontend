name: CI/CD - Deploy de Microsservi√ßos (Docker Compose)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. Checkout do C√≥digo
      uses: actions/checkout@v4

    - name: 2. Deploy e Build no Servidor VPS via SSH
      uses: appleboy/ssh-action@v1.0.3 
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        debug: true 
        script: |
          set -e
          echo "üöÄ Iniciando Deploy do FRONTEND..."

          # 1. Navega√ß√£o
          cd /home/${{ secrets.SSH_USERNAME }}/saas-frontend

          echo "‚¨áÔ∏è Baixando atualiza√ß√µes do Git..."
          git pull origin main

          # 2. Limpeza Profunda (CR√çTICO para Frontends pesados)
          echo "üõë Parando containers antigos..."
          sudo docker compose down --remove-orphans || true

          echo "üßπ Limpando cache pesado..."
          sudo docker builder prune -af
          sudo docker image prune -f

          # 3. Build Sequencial (Para evitar Erro 255 - OOM)
          echo "üé® Construindo FBMStore Web (1/2)..."
          sudo docker compose build fbmstore-web
          
          # 4. Start
          echo "üöÄ Subindo Frontends e Nginx..."
          sudo docker compose up -d

          # 5. Verifica√ß√£o de Sa√∫de "Perfeccionista"
          echo "‚è≥ Aguardando 20s para estabiliza√ß√£o..."
          sleep 20
          
          echo "üìä DEBUG: Servi√ßos rodando:"
          RUNNING_SERVICES=$(sudo docker compose ps --services --filter "status=running")
          
          if [ -z "$RUNNING_SERVICES" ]; then
             echo "‚ö†Ô∏è NENHUM SERVI√áO RODANDO!"
          else
             echo "$RUNNING_SERVICES"
          fi
          echo "---------------------------------------------------"

          # Verifica√ß√£o Espec√≠fica
          # Verifica Nginx (Essencial)
          if echo "$RUNNING_SERVICES" | grep -q "nginx-edge"; then
              echo "‚úÖ CHECK: Nginx Edge est√° on."
          else
              echo "‚ùå ERRO: Nginx Edge falhou."
              sudo docker compose logs nginx-edge --tail=20
              exit 1
          fi

          if echo "$RUNNING_SERVICES" | grep -q "fbmstore-web"; then
              echo "‚úÖ CHECK: FBMStore Web est√° on."
          else
              echo "‚ùå ERRO: FBMStore Web falhou."
              sudo docker compose logs fbmstore-web --tail=20
              exit 1
          fi
          
          echo "‚úÖ SUCESSO: Frontend e Loja Online no ar!"

    - name: üöÄ Sincroniza√ß√£o Total de Microsservi√ßos
      uses: appleboy/ssh-action@master
      with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîÑ Iniciando Rebuild e Sincroniza√ß√£o Geral..."
            cd /home/${{ secrets.SSH_USERNAME }}/saas-core && sudo docker compose up -d --build filestorage
            cd /home/${{ secrets.SSH_USERNAME }}/saas-business && sudo docker compose up -d --build gateway fbmstore-api
            cd /home/${{ secrets.SSH_USERNAME }}/saas-frontend && sudo docker compose up -d nginx-edge
            echo "‚úÖ Todos os servi√ßos sincronizados!"          