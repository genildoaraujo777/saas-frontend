# Este arquivo deve ser salvo como: nginx-edge.conf

# ===============================================
# BLOCO 1: Redirecionamento de HTTP (Porta 80) para HTTPS (Porta 443)
# ===============================================
server {
    listen 80;
    server_name spgpersonalizados.com.br www.spgpersonalizados.com.br 
                fbmstore.com.br www.fbmstore.com.br 
                gateway.fbmstore.com.br www.gateway.fbmstore.com.br;

    return 301 https://$host$request_uri;
}

# ===============================================
# BLOCO 2: Servidor HTTPS para o SPG WEB (spgpersonalizados.com.br)
# ===============================================
server {
    listen 443 ssl;
    server_name spgpersonalizados.com.br www.spgpersonalizados.com.br;

    # Certificados SPG
    ssl_certificate /etc/letsencrypt/live/spgpersonalizados.com.br/fullchain.pem; 
    ssl_certificate_key /etc/letsencrypt/live/spgpersonalizados.com.br/privkey.pem; 
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # PROXY REVERSO para o Container 'spg-web'
    location / {
        # proxy_pass aponta para o NOME DO SERVIÇO DOCKER-COMPOSE (spg-web) + porta interna 80
        proxy_pass http://spg-web:80;
        
        # Headers padrão para Proxy Reverso
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===============================================
# BLOCO 3: Servidor HTTPS para o FBMSTORE WEB (fbmstore.com.br)
# ===============================================
server {
    listen 443 ssl;
    server_name fbmstore.com.br www.fbmstore.com.br;

    # Certificados FBMSTORE
    ssl_certificate /etc/letsencrypt/live/fbmstore.com.br/fullchain.pem; 
    ssl_certificate_key /etc/letsencrypt/live/fbmstore.com.br/privkey.pem; 
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # PROXY REVERSO para o Container 'fbmstore-web'
    location / {
        # proxy_pass aponta para o NOME DO SERVIÇO DOCKER-COMPOSE (fbmstore-web) + porta interna 80
        proxy_pass http://fbmstore-web:80;
        
        # Headers padrão para Proxy Reverso
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}


# ===============================================
# BLOCO 4: Servidor HTTPS para o API GATEWAY (gateway.fbmstore.com.br)
# ===============================================
server {
    listen 443 ssl;
    server_name gateway.fbmstore.com.br www.gateway.fbmstore.com.br;

    # Certificados FBMSTORE (Assumindo que o gateway usa o mesmo certificado ou um wildcard)
    ssl_certificate /etc/letsencrypt/live/fbmstore.com.br/fullchain.pem; 
    ssl_certificate_key /etc/letsencrypt/live/fbmstore.com.br/privkey.pem; 
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Configuração de rotas para o backend
    location / {
        # proxy_pass aponta para o nome do SERVIÇO Docker Compose + Porta do Gateway (3000 ou 4000)
        # Usando a porta 3000, conforme a estrutura do seu override
        proxy_pass http://gateway:4000;
        
        # Headers essenciais para proxy reverso
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}